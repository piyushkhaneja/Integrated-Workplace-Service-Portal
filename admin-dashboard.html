<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JC NEXUS HUB - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

    <style>
        body { font-family: 'Poppins', sans-serif; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #a5b4fc; border-radius: 10px; }
        .sidebar-collapsed .nav-text, .sidebar-collapsed .logo-text, .sidebar-collapsed .profile-text, .sidebar-collapsed .nav-divider, .sidebar-collapsed .nav-section-title { display: none; }
        .sidebar-collapsed .nav-item { justify-content: center; }
        .sidebar-collapsed .logo-container { justify-content: center; padding-left: 0; padding-right: 0;}
        [x-cloak] { display: none !important; }
        .loading-spinner { border-top-color: #4338ca; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.8rem; font-weight: 600; text-transform: capitalize; }
        .status-pending, .status-in-progress, .status-preparing, .status-approved { background-color: #fef9c3; color: #ca8a04; }
        .status-resolved, .status-completed, .status-delivered, .status-ready-for-pickup, .status-active { background-color: #dcfce7; color: #16a34a; }
        .status-cancelled, .status-inactive { background-color: #fee2e2; color: #dc2626; }
        .nav-section-title { padding: 0.75rem 1.25rem 0.25rem; font-size: 0.75rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; }

        @media print {
            body * { visibility: hidden; }
            .printable-bill, .printable-bill * { visibility: visible; }
            .printable-bill { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 20px; }
            .print-hide { display: none; }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 antialiased">

    <div x-data="adminDashboardApp()" x-init="initApp()" class="flex h-screen bg-slate-100">
        
        <aside 
            :class="sidebarOpen ? 'w-80' : 'w-24 sidebar-collapsed'"
            class="bg-white text-slate-700 flex flex-col transition-all duration-300 ease-in-out shadow-lg print:hidden">
            
            <div class="flex items-center h-20 px-6 border-b border-slate-200 logo-container transition-all duration-300">
                <img src="/logo.png" alt="JC NEXUS Hub Logo" class="h-10 w-auto flex-shrink-0 rounded-full">
                <span class="ml-4 text-xl font-bold logo-text whitespace-nowrap">JC NEXUS HUB</span>
            </div>

            <nav class="flex-1 px-5 py-8 space-y-1 overflow-y-auto">
                <a href="#" @click.prevent="currentPage = 'dashboard'" :class="isActive('dashboard') ? 'bg-indigo-600 text-white' : 'hover:bg-slate-100'" class="flex items-center px-4 py-3 rounded-lg nav-item transition-colors">
                    <i class="fa-solid fa-chart-pie h-7 w-7 flex-shrink-0 text-xl flex items-center justify-center"></i>
                    <span class="ml-4 text-base font-medium nav-text">Dashboard</span>
                </a>
                <a href="#" @click.prevent="currentPage = 'userManagement'" :class="isActive('userManagement') ? 'bg-indigo-600 text-white' : 'hover:bg-slate-100'" class="flex items-center px-4 py-3 rounded-lg nav-item transition-colors">
                    <i class="fa-solid fa-users-gear h-7 w-7 flex-shrink-0 text-xl flex items-center justify-center"></i>
                    <span class="ml-4 text-base font-medium nav-text">User Management</span>
                </a>
                
                <div class="pt-3 nav-divider"><hr class="border-t border-slate-200"></div>
                <h3 class="nav-section-title">Request History</h3>
                
                <a href="#" @click.prevent="currentPage = 'history-full'" :class="isActive('history-full') ? 'bg-indigo-600 text-white' : 'hover:bg-slate-100'" class="flex items-center px-4 py-3 rounded-lg nav-item transition-colors">
                    <i class="fa-solid fa-clock-rotate-left h-7 w-7 flex-shrink-0 text-xl flex items-center justify-center"></i>
                    <span class="ml-4 text-base font-medium nav-text">Full History</span>
                </a>
                <a href="#" @click.prevent="currentPage = 'history-food'" :class="isActive('history-food') ? 'bg-indigo-600 text-white' : 'hover:bg-slate-100'" class="flex items-center px-4 py-3 rounded-lg nav-item transition-colors">
                    <i class="fa-solid fa-utensils h-7 w-7 flex-shrink-0 text-xl flex items-center justify-center"></i>
                    <span class="ml-4 text-base font-medium nav-text">Food</span>
                </a>
                <a href="#" @click.prevent="currentPage = 'history-store'" :class="isActive('history-store') ? 'bg-indigo-600 text-white' : 'hover:bg-slate-100'" class="flex items-center px-4 py-3 rounded-lg nav-item transition-colors">
                    <i class="fa-solid fa-store h-7 w-7 flex-shrink-0 text-xl flex items-center justify-center"></i>
                    <span class="ml-4 text-base font-medium nav-text">Store</span>
                </a>
                <a href="#" @click.prevent="currentPage = 'history-cleaning'" :class="isActive('history-cleaning') ? 'bg-indigo-600 text-white' : 'hover:bg-slate-100'" class="flex items-center px-4 py-3 rounded-lg nav-item transition-colors">
                    <i class="fa-solid fa-pump-soap h-7 w-7 flex-shrink-0 text-xl flex items-center justify-center"></i>
                    <span class="ml-4 text-base font-medium nav-text">Cleaning</span>
                </a>
                <a href="#" @click.prevent="currentPage = 'history-it'" :class="isActive('history-it') ? 'bg-indigo-600 text-white' : 'hover:bg-slate-100'" class="flex items-center px-4 py-3 rounded-lg nav-item transition-colors">
                    <i class="fa-solid fa-desktop h-7 w-7 flex-shrink-0 text-xl flex items-center justify-center"></i>
                    <span class="ml-4 text-base font-medium nav-text">IT Support</span>
                </a>
                
                <div class="pt-3 nav-divider"><hr class="border-t border-slate-200"></div>
                
                 <a href="#" @click.prevent="currentPage = 'userBills'" :class="isActive('userBills') ? 'bg-indigo-600 text-white' : 'hover:bg-slate-100'" class="flex items-center px-4 py-3 rounded-lg nav-item transition-colors">
                    <i class="fa-solid fa-file-invoice-dollar h-7 w-7 flex-shrink-0 text-xl flex items-center justify-center"></i>
                    <span class="ml-4 text-base font-medium nav-text">User Bills</span>
                </a>

                <div class="pt-3 nav-divider"><hr class="border-t border-slate-200"></div>

                <a href="#" @click.prevent="currentPage = 'broadcasts'" :class="isActive('broadcasts') ? 'bg-indigo-600 text-white' : 'hover:bg-slate-100'" class="flex items-center px-4 py-3 rounded-lg nav-item transition-colors">
                    <i class="fa-solid fa-bullhorn h-7 w-7 flex-shrink-0 text-xl flex items-center justify-center"></i>
                    <span class="ml-4 text-base font-medium nav-text">Broadcasts</span>
                </a>
                <a href="#" @click.prevent="currentPage = 'help'" :class="isActive('help') ? 'bg-indigo-600 text-white' : 'hover:bg-slate-100'" class="flex items-center px-4 py-3 rounded-lg nav-item transition-colors">
                    <i class="fa-solid fa-circle-question h-7 w-7 flex-shrink-0 text-xl flex items-center justify-center"></i>
                    <span class="ml-4 text-base font-medium nav-text">Help & Query</span>
                </a>
            </nav>

            <div @click="openProfileModal()" class="p-4 border-t border-slate-200 mt-auto cursor-pointer hover:bg-slate-50 transition-colors"><div class="flex items-center" :class="!sidebarOpen && 'justify-center'"><div class="flex-shrink-0"><template x-if="currentUser && currentUser.pic"><img :src="currentUser.pic" alt="Profile" class="h-12 w-12 rounded-full object-cover"></template><template x-if="!currentUser || !currentUser.pic"><div class="h-12 w-12 rounded-full bg-indigo-500 text-white flex items-center justify-center text-xl font-semibold"><span x-text="currentUser ? currentUser.fullName.charAt(0) : '?'"></span></div></template></div><div class="ml-4 profile-text"><p class="text-base font-semibold" x-text="currentUser ? currentUser.fullName : 'Loading...'"></p><p class="text-sm text-slate-500" x-text="currentUser ? currentUser.role : '...'"></p></div></div></div>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="flex items-center justify-between h-20 px-8 bg-white border-b border-slate-200 print:hidden"><button @click="sidebarOpen = !sidebarOpen" class="text-slate-500 hover:text-indigo-600 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500"><svg class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" /></svg></button><div class="flex items-center space-x-5"><div x-data="liveClock()" x-init="start()" class="text-base text-slate-600 hidden md:block"><span x-text="date"></span>, <span x-text="time" class="font-medium text-slate-800"></span></div>
                <div x-data="{ open: false }" class="relative"><button @click="open = !open; unreadNotificationsCount = 0" class="relative p-3 text-slate-500 bg-slate-100 rounded-full hover:bg-slate-200 focus:outline-none" title="Notifications"><span class="sr-only">View notifications</span><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 00-5-5.917V5a1 1 0 00-2 0v.083A6 6 0 006 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg><span x-show="unreadNotificationsCount > 0" class="absolute top-1 right-1 h-3 w-3 bg-red-500 rounded-full border-2 border-white"></span></button><div x-show="open" @click.away="open = false" x-transition class="absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl border z-50" x-cloak><div class="p-4 font-semibold border-b">Notifications</div><div class="p-2 max-h-96 overflow-y-auto"><template x-for="notification in notifications" :key="notification.id"><div class="p-3 rounded-lg hover:bg-slate-50"><p class="text-sm" x-html="notification.text"></p><p class="text-xs text-slate-500 mt-1" x-text="notification.time"></p></div></template><div x-show="notifications.length === 0" class="text-center p-8 text-slate-500 text-sm">No new notifications</div></div></div></div>
                <a href="/logout" class="p-3 text-slate-500 bg-slate-100 rounded-full hover:bg-slate-200 hover:text-red-600 focus:outline-none" title="Logout"><span class="sr-only">Logout</span><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg></a></div></header>
            
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-slate-100">
                <div x-show="isLoading" class="flex items-center justify-center h-full"><div class="flex items-center space-x-3"><div class="w-10 h-10 border-4 border-indigo-200 rounded-full loading-spinner"></div><p class="text-lg font-medium">Loading Admin Panel...</p></div></div>

                <div x-show="!isLoading && currentPage === 'dashboard'" x-cloak class="p-8 space-y-8">
                    <div><h1 class="text-4xl font-bold">Admin Dashboard</h1><p class="text-lg text-slate-600 mt-1">A comprehensive overview of all hub services.</p></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md"><p class="text-base font-medium text-slate-500">Total Pending</p><p class="text-4xl font-bold" x-text="stats.pendingCount || 0"></p></div>
                        <div class="bg-white p-6 rounded-lg shadow-md"><p class="text-base font-medium text-slate-500">Active Users</p><p class="text-4xl font-bold" x-text="stats.userCount || 0"></p></div>
                        <div class="bg-white p-6 rounded-lg shadow-md"><p class="text-base font-medium text-slate-500">Completed Today</p><p class="text-4xl font-bold" x-text="stats.completedToday || 0"></p></div>
                         <div class="bg-white p-6 rounded-lg shadow-md"><p class="text-base font-medium text-slate-500">Total Food Revenue</p><p class="text-4xl font-bold" x-text="formatCurrency(calculatedTotalRevenue)"></p></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1 space-y-6">
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h3 class="font-bold text-lg mb-2">Service Status</h3>
                                <div class="space-y-3 text-base">
                                    <div class="flex justify-between items-center"><span><i class="fa-solid fa-desktop text-indigo-500 w-6"></i> IT Support Tickets</span> <span class="font-bold bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded" x-text="stats.openTickets || 0"></span></div>
                                    <div class="flex justify-between items-center"><span><i class="fa-solid fa-pump-soap text-sky-500 w-6"></i> Cleaning Requests</span> <span class="font-bold bg-sky-100 text-sky-700 px-2 py-0.5 rounded" x-text="stats.pendingCleaning || 0"></span></div>
                                    <div class="flex justify-between items-center"><span><i class="fa-solid fa-store text-purple-500 w-6"></i> Store Requests</span> <span class="font-bold bg-purple-100 text-purple-700 px-2 py-0.5 rounded" x-text="stats.pendingStore || 0"></span></div>
                                    <div class="flex justify-between items-center"><span><i class="fa-solid fa-utensils text-amber-500 w-6"></i> Food Orders</span> <span class="font-bold bg-amber-100 text-amber-700 px-2 py-0.5 rounded" x-text="stats.pendingFood || 0"></span></div>
                                    <div class="flex justify-between items-center"><span><i class="fa-solid fa-mug-hot text-rose-500 w-6"></i> Beverage Orders</span> <span class="font-bold bg-rose-100 text-rose-700 px-2 py-0.5 rounded" x-text="stats.pendingBeverage || 0"></span></div>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold mb-3">Recent Activity</h3>
                                <div class="space-y-3 max-h-60 overflow-y-auto">
                                    <template x-for="activity in recentActivities.slice(0, 5)" :key="activity._id"><div class="flex items-start gap-3 text-sm"><div class="p-1.5 bg-slate-100 rounded-full mt-0.5" x-html="getActivityIcon(activity, 'w-4 h-4')"></div><div><p class="text-slate-800"><strong x-text="activity.requesterName"></strong> made a <strong x-text="formatRequestForDisplay(activity).type"></strong> request.</p><p class="text-xs text-slate-400" x-text="formatDate(activity.createdAt)"></p></div></div></template>
                                    <div x-show="!recentActivities.length" class="text-center py-4 text-slate-500 text-sm">No recent activity</div>
                                </div>
                            </div>
                        </div>
                        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                             <h3 class="font-bold text-lg mb-3">Today's Food Menu</h3>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 max-h-96 overflow-y-auto">
                                <template x-for="category in menuItems" :key="category.name"><div><h4 class="font-semibold mb-1.5" x-text="category.icon + ' ' + category.name"></h4><ul class="space-y-1 text-sm text-slate-600"><template x-for="item in category.items.slice(0, 4)" :key="item"><li class="pl-2 border-l-2 border-slate-200" x-text="item"></li></template></ul></div></template>
                            </div>
                        </div>
                    </div>
                </div>

                <div x-show="!isLoading && currentPage === 'userManagement'" x-cloak class="p-8 space-y-8">
                    <div><h1 class="text-4xl font-bold">User Management</h1><p class="text-lg text-slate-600 mt-1">View, add, or manage employee accounts.</p></div>
                    <div class="bg-white p-4 rounded-lg shadow-md flex justify-between items-center gap-4">
                        <div class="flex-grow"><input type="search" x-model.debounce.300ms="userSearchQuery" placeholder="Search by name, email, or employee ID..." class="w-full text-base px-4 py-2 rounded-md bg-slate-100 border-transparent focus:ring-2 focus:ring-indigo-500"></div>
                        <button @click="downloadUsersCSV()" class="px-5 py-2.5 text-base font-medium text-emerald-700 bg-emerald-100 rounded-md hover:bg-emerald-200">Download CSV</button>
                        <button @click="openUserModal('add')" class="px-5 py-2.5 text-base font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">Add New User</button>
                    </div>
                    <div class="bg-white rounded-lg shadow-md"><div class="overflow-x-auto"><table class="w-full text-base text-left"><thead class="text-sm text-slate-700 uppercase bg-slate-50"><tr><th scope="col" class="px-8 py-4">User</th><th scope="col" class="px-8 py-4">Employee ID</th><th scope="col" class="px-8 py-4">Role / Department</th><th scope="col" class="px-8 py-4">Contact</th><th scope="col" class="px-8 py-4">Status</th><th scope="col" class="px-8 py-4">Actions</th></tr></thead><tbody class="divide-y divide-slate-200"><template x-for="user in filteredUsers" :key="user.employeeId"><tr class="hover:bg-slate-50"><td class="px-8 py-5"><div class="flex items-center gap-4"><img :src="user.pic || 'https://placehold.co/40x40/c4b5fd/4338ca?text=' + user.fullName.charAt(0)" class="h-10 w-10 rounded-full object-cover"><span class="font-medium" x-text="user.fullName"></span></div></td><td class="px-8 py-5" x-text="user.employeeId"></td><td class="px-8 py-5"><div class="font-medium" x-text="user.role"></div><div class="text-sm text-slate-500" x-text="user.department || 'N/A'"></div></td><td class="px-8 py-5"><div x-text="user.email"></div><div class="text-sm text-slate-500" x-text="user.phone || 'N/A'"></div></td><td class="px-8 py-5"><span class="status-badge" :class="'status-' + user.status.toLowerCase()" x-text="user.status"></span></td><td class="px-8 py-5 whitespace-nowrap space-x-2"><button @click="openUserFoodHistoryModal(user)" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">Food History</button><button @click="openUserModal('edit', user)" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">Edit</button><button x-show="user.status === 'Active'" @click="deactivateUser(user)" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Deactivate</button></td></tr></template><tr x-show="filteredUsers.length === 0"><td colspan="6" class="text-center py-12 text-slate-500"><p class="font-semibold text-lg">No users found</p></td></tr></tbody></table></div></div>
                </div>

                <div x-show="!isLoading && currentPage === 'history-full'" x-cloak class="p-8 space-y-8">
                     <div><h1 class="text-4xl font-bold">Full Request History</h1><p class="text-lg text-slate-600 mt-1">A complete log of all service requests across all departments.</p></div>
                    <div class="bg-white p-4 rounded-lg shadow-md flex flex-wrap items-center gap-4">
                        <div class="flex-grow"><input type="search" x-model.debounce.300ms="historySearchQuery" placeholder="Search by user, details, status..." class="w-full text-base px-4 py-2 rounded-md bg-slate-100 focus:ring-2 focus:ring-indigo-500"></div>
                        <div><label class="text-sm font-medium">From:</label><input type="date" x-model="historyStartDate" class="ml-2 rounded-md border-slate-300"></div>
                        <div><label class="text-sm font-medium">To:</label><input type="date" x-model="historyEndDate" class="ml-2 rounded-md border-slate-300"></div>
                        <button @click="downloadFullHistoryCSV()" class="px-4 py-2 text-sm font-medium text-emerald-700 bg-emerald-100 rounded-md hover:bg-emerald-200 flex items-center gap-2"><i class="fa-solid fa-download"></i> Download CSV</button>
                    </div>
                    <div class="bg-white rounded-lg shadow-md"><div class="overflow-x-auto"><table class="w-full text-base text-left min-w-[1200px]"><thead class="text-sm text-slate-700 uppercase bg-slate-50"><tr><th class="px-6 py-4">Date</th><th class="px-6 py-4">User</th><th class="px-6 py-4">Service</th><th class="px-6 py-4">Details</th><th class="px-6 py-4">Resolve Note</th><th class="px-6 py-4">Status</th><th class="px-6 py-4">Rating</th><th class="px-6 py-4">Actions</th></tr></thead><tbody class="divide-y divide-slate-200"><template x-for="req in paginatedFullHistory" :key="req.uniqueId"><tr class="hover:bg-slate-50"><td class="px-6 py-4" x-text="formatDate(req.createdAt, true)"></td><td class="px-6 py-4"><div class="font-medium" x-text="req.requesterName"></div><div class="text-sm text-slate-500" x-text="req.employeeId"></div></td><td class="px-6 py-4 font-medium" x-text="req.type"></td><td class="px-6 py-4 max-w-xs truncate" x-text="req.details"></td><td class="px-6 py-4 max-w-xs truncate" x-text="getResolveNote(req)"></td><td class="px-6 py-4"><span class="status-badge" :class="'status-' + (req.status || 'unknown').toLowerCase().replace(/ /g, '-')" x-text="req.status"></span></td><td class="px-6 py-4" x-html="displayRating(req.rating)"></td><td class="px-6 py-4 whitespace-nowrap"><button @click="openRequestDetailsModal(req)" class="px-3 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">Details</button></td></tr></template><tr x-show="filteredFullHistory.length === 0"><td colspan="8" class="text-center py-12 text-slate-500"><p class="font-semibold text-lg">No requests found for the selected criteria</p></td></tr></tbody></table></div>
                    <div class="p-4 border-t flex justify-between items-center" x-show="filteredFullHistory.length > 0"><p class="text-sm text-slate-600">Showing <span x-text="(historyPage - 1) * historyPerPage + 1"></span> to <span x-text="Math.min(historyPage * historyPerPage, filteredFullHistory.length)"></span> of <span x-text="filteredFullHistory.length"></span></p><div class="flex gap-2"><button @click="historyPage--" :disabled="historyPage === 1" class="px-4 py-2 text-sm rounded-md disabled:bg-slate-200 disabled:cursor-not-allowed bg-indigo-600 text-white hover:bg-indigo-700">Prev</button><button @click="historyPage++" :disabled="historyPage * historyPerPage >= filteredFullHistory.length" class="px-4 py-2 text-sm rounded-md disabled:bg-slate-200 disabled:cursor-not-allowed bg-indigo-600 text-white hover:bg-indigo-700">Next</button></div></div>
                    </div>
                </div>

                <template x-if="!isLoading && ['history-food', 'history-store', 'history-cleaning', 'history-it'].includes(currentPage)">
                     <div class="p-8 space-y-8">
                         <div><h1 class="text-4xl font-bold" x-text="`${historyPageTitle} History`"></h1><p class="text-lg text-slate-600 mt-1" x-text="`View and manage all ${historyPageTitle.toLowerCase()} requests.`"></p></div>
                        <div class="bg-white p-4 rounded-lg shadow-md flex flex-wrap items-center gap-4"><div class="flex-grow"><input type="search" x-model.debounce.300ms="historySearchQuery" placeholder="Search by user, details, status..." class="w-full text-base px-4 py-2 rounded-md bg-slate-100 focus:ring-2 focus:ring-indigo-500"></div><button @click="downloadDepartmentHistoryCSV()" class="px-4 py-2 text-sm font-medium text-emerald-700 bg-emerald-100 rounded-md hover:bg-emerald-200 flex items-center gap-2"><i class="fa-solid fa-download"></i> Download CSV</button></div>
                        <div class="bg-white rounded-lg shadow-md overflow-x-auto">
                            <table class="w-full text-base text-left min-w-[1200px]"><thead class="text-sm text-slate-700 uppercase bg-slate-50"><tr><th class="px-6 py-4">Date</th><th class="px-6 py-4">User</th><th class="px-6 py-4">Details</th><th class="px-6 py-4">Resolve Note</th><th class="px-6 py-4">Status</th><th class="px-6 py-4">Rating</th><th class="px-6 py-4">Actions</th></tr></thead><tbody class="divide-y divide-slate-200"><template x-for="req in paginatedDepartmentHistory" :key="req.uniqueId"><tr class="hover:bg-slate-50"><td class="px-6 py-4" x-text="formatDate(req.createdAt, true)"></td><td class="px-6 py-4"><div class="font-medium" x-text="req.requesterName"></div><div class="text-sm text-slate-500" x-text="req.employeeId"></div></td><td class="px-6 py-4 max-w-sm truncate" x-text="req.details"></td><td class="px-6 py-4 max-w-xs truncate" x-text="getResolveNote(req)"></td><td class="px-6 py-4"><span class="status-badge" :class="'status-' + (req.status || 'unknown').toLowerCase().replace(/ /g, '-')" x-text="req.status"></span></td><td class="px-6 py-4" x-html="displayRating(req.rating)"></td><td class="px-6 py-4 whitespace-nowrap"><button @click="openRequestDetailsModal(req)" class="px-3 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">Details</button><button x-show="currentPage === 'history-food'" @click="openBillModal(req)" class="ml-2 px-3 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700">View Bill</button></td></tr></template><tr x-show="filteredDepartmentHistory.length === 0"><td colspan="7" class="text-center py-12 text-slate-500"><p class="font-semibold text-lg">No requests found</p></td></tr></tbody></table>
                        </div>
                    </div>
                </template>

                <div x-show="!isLoading && currentPage === 'userBills'" x-cloak class="p-8 space-y-8">
                     <div><h1 class="text-4xl font-bold">User Food Bills</h1><p class="text-lg text-slate-600 mt-1">Summary of total food expenses per user.</p></div>
                    <div class="bg-white p-4 rounded-lg shadow-md flex justify-between items-center gap-4">
                        <div class="flex-grow"><input type="search" x-model.debounce.300ms="userBillSearchQuery" placeholder="Search by user name or employee ID..." class="w-full text-base px-4 py-2 rounded-md bg-slate-100 border-transparent focus:ring-2 focus:ring-indigo-500"></div>
                        <button @click="downloadUserBillsCSV()" class="px-5 py-2.5 text-base font-medium text-emerald-700 bg-emerald-100 rounded-md hover:bg-emerald-200">Download CSV</button>
                    </div>
                    <div class="bg-white rounded-lg shadow-md"><div class="overflow-x-auto"><table class="w-full text-base text-left"><thead class="text-sm text-slate-700 uppercase bg-slate-50"><tr><th class="px-8 py-4">User</th><th class="px-8 py-4">Department</th><th class="px-8 py-4 text-center">Total Orders</th><th class="px-8 py-4 text-right">Total Bill</th><th class="px-8 py-4 w-32 text-center">Actions</th></tr></thead>
                        <tbody class="divide-y divide-slate-200">
                            <template x-for="bill in filteredUserBills" :key="bill.employeeId">
                                <tr class="hover:bg-slate-50">
                                    <td class="px-8 py-5"><div class="flex items-center gap-4"><img :src="bill.pic || 'https://placehold.co/40x40/c4b5fd/4338ca?text=' + bill.fullName.charAt(0)" class="h-10 w-10 rounded-full object-cover"><span class="font-medium" x-text="bill.fullName"></span></div></td>
                                    <td class="px-8 py-5" x-text="bill.department || 'N/A'"></td>
                                    <td class="px-8 py-5 text-center" x-text="bill.totalOrders"></td>
                                    <td class="px-8 py-5 text-right font-semibold text-indigo-600" x-text="formatCurrency(bill.totalBill)"></td>
                                    <td class="px-8 py-5 text-center">
                                        <button @click="openUserBillHistoryModal(bill)" class="px-3 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">View History</button>
                                    </td>
                                </tr>
                            </template>
                            <tr x-show="filteredUserBills.length === 0"><td colspan="5" class="text-center py-12 text-slate-500"><p class="font-semibold text-lg">No users found.</p></td></tr>
                        </tbody>
                    </table></div></div>
                </div>
                
                <div x-show="!isLoading && currentPage === 'broadcasts'" x-cloak class="p-8 space-y-8">
                    <div><h1 class="text-4xl font-bold">Manage Broadcasts</h1><p class="text-lg text-slate-600 mt-1">Create and view company-wide announcements.</p></div>
                    <div class="max-w-4xl mx-auto space-y-8"><div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl font-bold mb-4">Create New Broadcast</h3><form @submit.prevent="sendBroadcast"><textarea x-model="newBroadcastMessage" rows="4" placeholder="Type your announcement here..." class="w-full text-base p-3 rounded-md border-slate-300 focus:ring-2 focus:ring-indigo-500" required></textarea><div class="flex justify-end mt-4"><button type="submit" class="px-6 py-3 text-base font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700">Post</button></div></form></div><h3 class="text-2xl font-bold pt-4 border-t">Recent Broadcasts</h3><template x-for="post in broadcasts" :key="post._id"><div class="bg-white p-6 rounded-lg shadow-md flex items-start gap-5"><div class="flex-shrink-0"><div class="h-12 w-12 rounded-full bg-indigo-500 text-white flex items-center justify-center text-xl font-semibold"><span x-text="post.senderName.charAt(0)"></span></div></div><div class="flex-grow"><div class="flex items-baseline justify-between"><div><p class="font-bold text-lg" x-text="post.senderName"></p><p class="text-sm text-slate-500" x-text="post.senderRole"></p></div><p class="text-sm text-slate-400" x-text="formatDate(post.createdAt)"></p></div><p class="mt-3 text-base text-slate-700" x-text="post.message"></p></div></div></template><div x-show="broadcasts.length === 0" class="text-center py-12 text-slate-500"><p class="font-semibold text-lg">No Broadcasts Yet</p></div></div>
                </div>
                <div x-show="!isLoading && currentPage === 'help'" x-cloak class="p-8 space-y-8">
                    <div><h1 class="text-4xl font-bold">Help & Queries</h1><p class="text-lg text-slate-600 mt-1">Find answers to common questions.</p></div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 pt-4"><div class="bg-white p-8 rounded-lg shadow-md"><h3 class="text-xl font-bold mb-2">Request Management</h3><p class="text-slate-600">Guides on filtering requests, updating status, and using the new date filters.</p></div><div class="bg-white p-8 rounded-lg shadow-md"><h3 class="text-xl font-bold mb-2">User Management</h3><p class="text-slate-600">Instructions for adding, editing, and deactivating user accounts.</p></div><div class="bg-white p-8 rounded-lg shadow-md"><h3 class="text-xl font-bold mb-2">Billing & Notifications</h3><p class="text-slate-600">Learn how to create manual bills and notify users about payments.</p></div></div>
                </div>

            </main>
        </div>

        <div x-show="isProfileModalOpen" @keydown.escape.window="closeProfileModal()" x-transition.opacity class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4" x-cloak>
            <div @click.away="closeProfileModal()" class="bg-white rounded-2xl shadow-xl w-full max-w-3xl" x-show="isProfileModalOpen" x-transition.scale>
                <div class="p-8" x-show="editableUser">
                    <h2 class="text-2xl font-bold mb-6">My Profile</h2>
                    <div class="flex flex-col md:flex-row gap-8">
                        <div class="flex-shrink-0 text-center md:w-1/3">
                            <img class="h-32 w-32 rounded-full object-cover mx-auto ring-4 ring-indigo-200" :src="profilePicPreviewUrl || (editableUser.pic) || 'https://placehold.co/128x128/c4b5fd/4338ca?text=' + (editableUser.fullName ? editableUser.fullName.charAt(0) : 'U')" alt="Profile Picture">
                            <input type="file" @change="handleProfilePicChange" x-ref="profilePicInput" class="hidden" accept="image/*">
                            <button @click="$refs.profilePicInput.click()" class="mt-4 text-base font-semibold text-indigo-600 hover:text-indigo-800">Change Picture</button>
                        </div>
                        <div class="flex-grow space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="block text-sm font-medium text-slate-500">Full Name</label><input type="text" :value="editableUser.fullName" disabled class="mt-1 w-full bg-slate-100 rounded-md border-slate-300 cursor-not-allowed px-3 py-2"></div>
                                <div><label class="block text-sm font-medium text-slate-500">Employee ID</label><input type="text" :value="editableUser.employeeId" disabled class="mt-1 w-full bg-slate-100 rounded-md border-slate-300 cursor-not-allowed px-3 py-2"></div>
                            </div>
                            <div><label class="block text-sm font-medium text-slate-500">Email</label><input type="email" :value="editableUser.email" disabled class="mt-1 w-full bg-slate-100 rounded-md border-slate-300 cursor-not-allowed px-3 py-2"></div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="block text-sm font-medium text-slate-500">Department</label><input type="text" :value="editableUser.department" disabled class="mt-1 w-full bg-slate-100 rounded-md border-slate-300 cursor-not-allowed px-3 py-2"></div>
                                <div><label class="block text-sm font-medium text-slate-500">Role</label><input type="text" :value="editableUser.role" disabled class="mt-1 w-full bg-slate-100 rounded-md border-slate-300 cursor-not-allowed px-3 py-2"></div>
                            </div>
                            <div><label for="phone" class="block text-sm font-medium">Phone Number</label><input id="phone" type="tel" x-model="editableUser.phone" class="mt-1 w-full rounded-md border-slate-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></div>
                            <div><label for="address" class="block text-sm font-medium">Address</label><textarea id="address" rows="2" x-model="editableUser.address" class="mt-1 w-full rounded-md border-slate-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea></div>
                        </div>
                    </div>
                    <div class="mt-8 pt-5 border-t flex justify-end gap-3"><button @click="closeProfileModal()" type="button" class="px-5 py-2.5 text-base font-medium bg-white border border-slate-300 rounded-md hover:bg-slate-50">Cancel</button><button @click="saveProfileChanges()" type="button" class="px-5 py-2.5 text-base font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">Save Changes</button></div>
                </div>
            </div>
        </div>

        <div x-show="isUserModalOpen" @keydown.escape.window="closeUserModal()" x-transition.opacity class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4" x-cloak>
            <div @click.away="closeUserModal()" class="bg-white rounded-2xl shadow-xl w-full max-w-4xl" x-show="isUserModalOpen" x-transition.scale>
                <form @submit.prevent="saveUser()">
                    <div class="p-8">
                        <h2 class="text-2xl font-bold mb-6" x-text="modalMode === 'add' ? 'Add New User' : 'Edit User Details'"></h2>
                        <div class="flex flex-col md:flex-row gap-8">
                            <div class="md:w-1/3 text-center flex flex-col items-center">
                                <div class="h-32 w-32 rounded-full bg-slate-200 flex items-center justify-center text-5xl font-bold text-slate-400 ring-4 ring-slate-100" x-show="modalMode === 'add'">?</div>
                                <div class="relative" x-show="modalMode === 'edit'">
                                    <template x-if="userFormData.pic"><img :src="userFormData.pic" alt="Profile" class="h-32 w-32 rounded-full object-cover ring-4 ring-indigo-200" /></template>
                                    <template x-if="!userFormData.pic"><div class="h-32 w-32 rounded-full bg-indigo-500 text-white flex items-center justify-center text-5xl font-semibold"><span x-text="userFormData.fullName ? userFormData.fullName.charAt(0) : 'U'"></span></div></template>
                                </div>
                                <div class="mt-4 text-center">
                                    <p class="text-xl font-bold" x-text="userFormData.fullName || 'New User'"></p>
                                    <p class="text-sm text-slate-500" x-text="userFormData.employeeId || 'New Employee ID'"></p>
                                </div>
                                <div class="mt-4 text-sm text-slate-500 bg-slate-50 p-3 rounded-lg w-full text-left" x-show="modalMode === 'edit'">
                                    <p><strong>Joined On:</strong> <span x-text="formatDate(userFormData.joiningDate, false)"></span></p>
                                </div>
                            </div>
                            <div class="md:w-2/3 flex-grow space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label class="block text-sm font-medium">Full Name</label><input type="text" x-model="userFormData.fullName" class="mt-1 w-full rounded-md border-slate-300" required></div>
                                    <div><label class="block text-sm font-medium">Employee ID</label><input type="text" x-model="userFormData.employeeId" class="mt-1 w-full rounded-md border-slate-300" :disabled="modalMode === 'edit'" :class="{'bg-slate-100': modalMode === 'edit'}" required></div>
                                </div>
                                <div><label class="block text-sm font-medium">Email</label><input type="email" x-model="userFormData.email" class="mt-1 w-full rounded-md border-slate-300" required></div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label class="block text-sm font-medium">Phone</label><input type="tel" x-model="userFormData.phone" class="mt-1 w-full rounded-md border-slate-300"></div>
                                    <div><label class="block text-sm font-medium">Department</label><input type="text" x-model="userFormData.department" class="mt-1 w-full rounded-md border-slate-300"></div>
                                </div>
                                <div><label class="block text-sm font-medium">Address</label><textarea x-model="userFormData.address" rows="2" class="mt-1 w-full rounded-md border-slate-300"></textarea></div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label class="block text-sm font-medium">Role</label><select x-model="userFormData.role" class="mt-1 w-full rounded-md border-slate-300" required><option>Employee</option><option>Admin</option><option>IT</option><option>Cleaning</option><option>Canteen</option><option>Store</option></select></div>
                                    <div><label class="block text-sm font-medium">Status</label><select x-model="userFormData.status" class="mt-1 w-full rounded-md border-slate-300" required><option>Active</option><option>Inactive</option></select></div>
                                </div>
                                <div><label class="block text-sm font-medium">Password</label><input type="password" x-model="userFormData.password" class="mt-1 w-full rounded-md border-slate-300" :placeholder="modalMode === 'edit' ? 'Leave blank to keep unchanged' : ''" :required="modalMode === 'add'"></div>
                            </div>
                        </div>
                    </div>
                    <div class="px-6 py-4 bg-slate-50 rounded-b-2xl flex justify-end gap-3"><button @click="closeUserModal()" type="button" class="px-5 py-2.5 rounded-md">Cancel</button><button type="submit" class="px-5 py-2.5 text-white bg-indigo-600 rounded-md">Save Changes</button></div>
                </form>
            </div>
        </div>
        
        <div x-show="isRequestDetailsModalOpen" @keydown.escape.window="closeRequestDetailsModal()" x-transition.opacity class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4" x-cloak><div @click.away="closeRequestDetailsModal()" class="bg-white rounded-2xl shadow-xl w-full max-w-2xl" x-show="isRequestDetailsModalOpen" x-transition.scale><div class="p-6" x-if="selectedRequest"><div class="flex justify-between items-center pb-3 border-b"><h2 class="text-2xl font-bold">Request Details</h2><button @click="closeRequestDetailsModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button></div><div class="mt-4 space-y-4 max-h-[70vh] overflow-y-auto pr-2"><div class="grid grid-cols-2 gap-4 text-base"><div><strong class="text-slate-500">Employee:</strong> <span x-text="selectedRequest.requesterName"></span></div><div><strong class="text-slate-500">Service:</strong> <span x-text="selectedRequest.type"></span></div><div><strong class="text-slate-500">Status:</strong> <span class="status-badge" :class="'status-' + selectedRequest.status.toLowerCase().replace(/ /g, '-')" x-text="selectedRequest.status"></span></div></div><hr><div class="space-y-3"><h3 class="font-semibold text-lg">Specifics:</h3><template x-if="selectedRequest.requestType === 'ticket'"><div class="grid grid-cols-2 gap-4"><div><strong class="text-slate-500">Issue:</strong> <span x-text="selectedRequest.mainIssue"></span></div><div><strong class="text-slate-500">Priority:</strong> <span x-text="selectedRequest.priority"></span></div><div class="col-span-2"><strong class="text-slate-500">Description:</strong> <p x-text="selectedRequest.problemDescription"></p></div></div></template><template x-if="selectedRequest.requestType === 'cleaning'"><p><strong class="text-slate-500">Location:</strong> <span x-text="`${selectedRequest.floorNumber}, ${selectedRequest.deskNumber}`"></span></p></template><template x-if="['food', 'store'].includes(selectedRequest.requestType)"><p><strong class="text-slate-500">Item:</strong> <span x-text="selectedRequest.details"></span></p></template></div><template x-if="selectedRequest.rating"><hr><div class="space-y-3"><h3 class="font-semibold text-lg">Feedback:</h3><div><strong class="text-slate-500">Rating:</strong> <span class="text-amber-500" x-html="displayRating(selectedRequest.rating)"></span></div></div></template></div></div></div></div>
        
        <div x-show="isBillModalOpen" @keydown.escape.window="closeBillModal()" x-transition.opacity class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4" x-cloak>
            <div @click.away="closeBillModal()" class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4" x-show="isBillModalOpen" x-transition.scale>
                <div class="printable-bill">
                    <div class="p-8" x-show="billToView">
                        <div class="text-center mb-6"><img src="/logo.png" alt="JC NEXUS Hub Logo" class="h-16 w-auto mx-auto"><h2 class="text-2xl font-bold mt-2">JC NEXUS HUB - Canteen</h2><p class="text-sm text-slate-500">Tax Invoice</p></div>
                        <div class="flex justify-between border-b pb-4 mb-4 text-sm"><div><p class="font-bold">Billed To:</p><p x-text="billToView.requesterName"></p><p x-text="'ID: ' + billToView.employeeId"></p></div><div class="text-right"><p><span class="font-bold">Bill No:</span> <span x-text="billToView._id.slice(-6).toUpperCase()"></span></p><p><span class="font-bold">Date:</span> <span x-text="formatDate(billToView.completedAt || billToView.createdAt, true)"></span></p><p><span class="font-bold">Paid Via:</span> <span x-text="billToView.paymentMethod"></span></p></div></div>
                        <table class="w-full text-left text-sm mb-4"><thead><tr class="bg-slate-100"><th class="py-2 px-4">Item</th><th class="py-2 px-4 text-center">Qty</th><th class="py-2 px-4 text-right">Price</th><th class="py-2 px-4 text-right">Total</th></tr></thead><tbody><template x-for="item in billToView.items"><tr class="border-b"><td class="py-2 px-4" x-text="item.name"></td><td class="py-2 px-4 text-center" x-text="item.quantity"></td><td class="py-2 px-4 text-right" x-text="formatCurrency(item.price)"></td><td class="py-2 px-4 text-right" x-text="formatCurrency(item.price * item.quantity)"></td></tr></template></tbody></table>
                        <div class="pt-4 flex justify-end"><div class="w-1/2"><div class="flex justify-between text-lg font-bold"><span>Grand Total:</span><span x-text="formatCurrency(billToView.totalPrice)"></span></div></div></div>
                        <div class="mt-8 text-center text-xs text-slate-500"><p>Thank you for your order!</p></div>
                    </div>
                </div>
                <div class="px-8 pb-8 flex gap-4 print-hide"><button @click="window.print()" class="w-full py-2 px-4 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Print Bill</button><button @click="closeBillModal()" class="w-full py-2 px-4 rounded-lg bg-slate-200 text-slate-700 hover:bg-slate-300">Close</button></div>
            </div>
        </div>

        <div x-show="isUserFoodHistoryModalOpen" @keydown.escape.window="closeUserFoodHistoryModal()" x-transition.opacity class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4" x-cloak>
            <div @click.away="closeUserFoodHistoryModal()" class="bg-white rounded-2xl shadow-xl w-full max-w-6xl mx-auto flex flex-col" style="height: 85vh;" x-show="isUserFoodHistoryModalOpen" x-transition.scale>
                <div class="p-6 border-b"><h2 class="text-xl font-bold">Food Order History For <span x-text="selectedUserForHistory ? selectedUserForHistory.fullName : ''"></span></h2></div>
                <div class="p-6 flex-1 overflow-y-auto">
                    <table class="w-full text-base text-left">
                        <thead class="text-sm text-slate-700 uppercase bg-slate-100 sticky top-0">
                            <tr><th class="px-4 py-3">Order Date</th><th class="px-4 py-3">Items</th><th class="px-4 py-3 text-center">Qty</th><th class="px-4 py-3">Paid Via</th><th class="px-4 py-3">Delivered At</th><th class="px-4 py-3 text-right">Total</th><th class="px-4 py-3">Status</th><th class="px-4 py-3 text-center">Actions</th></tr>
                        </thead>
                        <tbody class="divide-y divide-slate-200">
                            <template x-for="order in selectedUserFoodOrders" :key="order._id">
                                <tr class="hover:bg-slate-50">
                                    <td class="px-4 py-4" x-text="formatDate(order.createdAt)"></td>
                                    <td class="px-4 py-4 font-medium max-w-xs truncate" x-text="order.details"></td>
                                    <td class="px-4 py-4 text-center" x-text="order.items.reduce((acc, item) => acc + item.quantity, 0)"></td>
                                    <td class="px-4 py-4" x-text="order.paymentMethod || 'N/A'"></td>
                                    <td class="px-4 py-4" x-text="formatDate(order.completedAt)"></td>
                                    <td class="px-4 py-4 font-bold text-right" x-text="formatCurrency(order.totalPrice)"></td>
                                    <td class="px-4 py-4"><span class="status-badge" :class="'status-' + (order.status || '').toLowerCase().replace(/ /g, '-')" x-text="order.status"></span></td>
                                    <td class="px-4 py-4 text-center"><button @click="openBillModal(order)" class="px-3 py-1 text-xs font-medium text-white bg-green-600 rounded-md hover:bg-green-700">View Bill</button></td>
                                </tr>
                            </template>
                            <tr x-show="selectedUserFoodOrders.length === 0"><td colspan="8" class="text-center py-12 text-slate-500"><p>No food orders found for this user.</p></td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="p-4 bg-slate-50 border-t flex justify-end"><button @click="closeUserFoodHistoryModal()" type="button" class="px-5 py-2.5 rounded-md">Close</button></div>
            </div>
        </div>

        <div x-show="isUserBillHistoryModalOpen" @keydown.escape.window="closeUserBillHistoryModal()" x-transition.opacity class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4" x-cloak>
            <div @click.away="closeUserBillHistoryModal()" class="bg-white rounded-2xl shadow-xl w-full max-w-6xl mx-auto flex flex-col" style="height: 85vh;" x-show="isUserBillHistoryModalOpen" x-transition.scale>
                <div class="p-6 border-b"><h2 class="text-xl font-bold">Food Order History For <span x-text="selectedBillUser ? selectedBillUser.fullName : ''"></span></h2></div>
                <div class="p-6 flex-1 overflow-y-auto">
                     <table class="w-full text-base text-left">
                        <thead class="text-sm text-slate-700 uppercase bg-slate-100 sticky top-0">
                            <tr><th class="px-4 py-3">Order Date</th><th class="px-4 py-3">Items</th><th class="px-4 py-3 text-center">Qty</th><th class="px-4 py-3">Paid Via</th><th class="px-4 py-3">Delivered At</th><th class="px-4 py-3 text-right">Total</th><th class="px-4 py-3">Status</th><th class="px-4 py-3 text-center">Actions</th></tr>
                        </thead>
                        <tbody class="divide-y divide-slate-200">
                            <template x-for="order in selectedBillUserOrders" :key="order._id">
                                <tr class="hover:bg-slate-50">
                                    <td class="px-4 py-4" x-text="formatDate(order.createdAt)"></td>
                                    <td class="px-4 py-4 font-medium max-w-xs truncate" x-text="order.details"></td>
                                    <td class="px-4 py-4 text-center" x-text="order.items.reduce((acc, item) => acc + item.quantity, 0)"></td>
                                    <td class="px-4 py-4" x-text="order.paymentMethod || 'N/A'"></td>
                                    <td class="px-4 py-4" x-text="formatDate(order.completedAt)"></td>
                                    <td class="px-4 py-4 font-bold text-right" x-text="formatCurrency(order.totalPrice)"></td>
                                    <td class="px-4 py-4"><span class="status-badge" :class="'status-' + (order.status || '').toLowerCase().replace(/ /g, '-')" x-text="order.status"></span></td>
                                    <td class="px-4 py-4 text-center"><button @click="openBillModal(order)" class="px-3 py-1 text-xs font-medium text-white bg-green-600 rounded-md hover:bg-green-700">View Bill</button></td>
                                </tr>
                            </template>
                            <tr x-show="selectedBillUserOrders.length === 0">
                                <td colspan="8" class="text-center py-12 text-slate-500"><p>No food orders found for this user.</p></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="p-4 bg-slate-50 border-t flex justify-end"><button @click="closeUserBillHistoryModal()" type="button" class="px-5 py-2.5 rounded-md">Close</button></div>
            </div>
        </div>

    </div>

    <script>
    const socket = io();

    function adminDashboardApp() {
        return {
            // Core State
            sidebarOpen: true,
            currentPage: 'dashboard',
            isLoading: true,
            stats: {},
            currentUser: null,
            
            // Data Arrays
            allRequests: [],
            allUsers: [],
            notifications: [],
            unreadNotificationsCount: 0,
            broadcasts: [],
            recentActivities: [],
            userBills: [],
            
            // UI State
            userSearchQuery: '',
            historySearchQuery: '',
            historyStartDate: '',
            historyEndDate: '',
            historyPage: 1,
            historyPerPage: 10,
            userBillSearchQuery: '',

            // Modal State & Forms
            isProfileModalOpen: false,
            editableUser: null,
            profilePicPreviewUrl: null,
            isUserModalOpen: false,
            modalMode: 'add',
            userFormData: {},
            isRequestDetailsModalOpen: false,
            selectedRequest: null,
            isBillModalOpen: false,
            billToView: null,
            isUserFoodHistoryModalOpen: false, 
            selectedUserForHistory: null,      
            selectedUserFoodOrders: [],      
            isUserBillHistoryModalOpen: false,
            selectedBillUser: null,
            selectedBillUserOrders: [],
            newBroadcastMessage: '',
            
            menuItems: [
                { name: 'Thali & Combos', icon: '', items: ['Executive Veg Thali', 'Paneer Butter Masala Combo', 'Dal Makhani Combo', 'Rajma Chawal Bowl'] },
                { name: 'Chinese Specials', icon: '', items: ['Veg Hakka Noodles', 'Veg Manchurian', 'Chilli Paneer Gravy', 'Veg Spring Roll'] },
                { name: 'Pizza & Continental', icon: '', items: ['Margherita Pizza', 'Veggie Delight Pizza', 'White Sauce Pasta', 'Red Sauce Pasta'] },
                { name: 'All-Day Snacks', icon: '', items: ['Pav Bhaji', 'Masala Dosa', 'Samosa Chaat', 'Aloo Tikki Chaat'] },
            ],
            
            // COMPUTED PROPERTIES
            get calculatedTotalRevenue() { return this.userBills.reduce((acc, bill) => acc + bill.totalBill, 0); },
            get filteredUserBills() { if (!this.userBillSearchQuery.trim()) return this.userBills; const query = this.userBillSearchQuery.toLowerCase(); return this.userBills.filter(bill => (bill.fullName && bill.fullName.toLowerCase().includes(query)) || (bill.employeeId && bill.employeeId.toLowerCase().includes(query))); },
            get filteredUsers() { if (!this.userSearchQuery.trim()) return this.allUsers; const query = this.userSearchQuery.toLowerCase(); return this.allUsers.filter(user => (user.fullName && user.fullName.toLowerCase().includes(query)) || (user.email && user.email.toLowerCase().includes(query)) || (user.employeeId && user.employeeId.toLowerCase().includes(query))); },
            get filteredFullHistory() { let requests = this.allRequests; if (this.historyStartDate) { requests = requests.filter(r => new Date(r.createdAt) >= new Date(this.historyStartDate)); } if (this.historyEndDate) { const end = new Date(this.historyEndDate); end.setHours(23, 59, 59, 999); requests = requests.filter(r => new Date(r.createdAt) <= end); } if (this.historySearchQuery.trim()) { const query = this.historySearchQuery.toLowerCase(); requests = requests.filter(req => (req.requesterName && req.requesterName.toLowerCase().includes(query)) || (req.details && req.details.toLowerCase().includes(query)) || (req.status && req.status.toLowerCase().includes(query))); } return requests; },
            get paginatedFullHistory() { const start = (this.historyPage - 1) * this.historyPerPage; return this.filteredFullHistory.slice(start, start + this.historyPerPage); },
            get departmentHistoryType() { return this.currentPage.split('-')[1]; },
            get historyPageTitle() { if (!this.departmentHistoryType) return ''; return { food: 'Food', store: 'Store', cleaning: 'Cleaning', it: 'IT Support' }[this.departmentHistoryType]; },
            get filteredDepartmentHistory() { const typeMap = { 'it': 'ticket', 'cleaning': 'cleaning', 'food': 'food', 'store': 'store' }; const requestTypeToFilter = typeMap[this.departmentHistoryType]; let requests = this.allRequests.filter(r => r.requestType === requestTypeToFilter); if (this.historySearchQuery.trim()) { const query = this.historySearchQuery.toLowerCase(); requests = requests.filter(req => (req.requesterName && req.requesterName.toLowerCase().includes(query)) || (req.details && req.details.toLowerCase().includes(query))); } return requests; },
            get paginatedDepartmentHistory() { const start = (this.historyPage - 1) * this.historyPerPage; return this.filteredDepartmentHistory.slice(start, start + this.historyPerPage); },

            // INIT & DATA
            initApp() { this.fetchData(); this.setupSocketListeners(); this.$watch('currentPage', () => { this.historySearchQuery = ''; this.historyPage = 1; }); },
            async fetchData() { this.isLoading = true; try { const [userRes, dataRes, billsRes] = await Promise.all([fetch('/api/user-info'), fetch('/api/admin/dashboard-data'), fetch('/api/admin/user-food-bills')]); if (!userRes.ok || !dataRes.ok || !billsRes.ok) throw new Error('Failed to fetch admin data.'); this.currentUser = await userRes.json(); const data = await dataRes.json(); this.userBills = await billsRes.json(); this.stats = data.stats || {}; this.allUsers = (data.users || []).sort((a, b) => a.fullName.localeCompare(b.fullName)); this.recentActivities = data.recentActivities || []; this.broadcasts = data.broadcasts || []; const combined = [ ...(data.tickets || []).map(t => this.formatRequestForDisplay(t, 'ticket')), ...(data.cleaning || []).map(c => this.formatRequestForDisplay(c, 'cleaning')), ...(data.orders || []).map(o => this.formatRequestForDisplay(o, 'beverage')), ...(data.foodOrders || []).map(f => this.formatRequestForDisplay(f, 'food')), ...(data.storeRequests || []).map(s => this.formatRequestForDisplay(s, 'store')) ]; this.allRequests = combined.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); } catch (error) { console.error("Admin Dashboard Loading Error:", error); alert(error.message); } finally { this.isLoading = false; } },
            setupSocketListeners() { const handleUpdate = () => this.fetchData(); socket.on('new-request-admin', handleUpdate); socket.on('request-updated-admin', handleUpdate); socket.on('user-list-updated', handleUpdate); socket.on('new-broadcast', (newPost) => this.broadcasts.unshift(newPost)); },
            
            // MODALS & ACTIONS
            openProfileModal() { if (this.currentUser) { this.editableUser = JSON.parse(JSON.stringify(this.currentUser)); this.isProfileModalOpen = true; } },
            closeProfileModal() { this.isProfileModalOpen = false; },
            async saveProfileChanges() { try { const res = await fetch('/api/profile/update', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ address: this.editableUser.address, phone: this.editableUser.phone }) }); if (!res.ok) throw new Error('Failed to update.'); this.currentUser = await res.json(); alert('Profile updated!'); this.closeProfileModal(); } catch (e) { alert(e.message); } },
            openUserModal(mode, user = null) { this.modalMode = mode; this.userFormData = mode === 'add' ? { role: 'Employee', status: 'Active' } : { ...user, password: '' }; this.isUserModalOpen = true; },
            closeUserModal() { this.isUserModalOpen = false; },
            async saveUser() { const url = this.modalMode === 'add' ? '/api/admin/users' : `/api/admin/users/${this.userFormData._id}`; try { const res = await fetch(url, { method: this.modalMode === 'add' ? 'POST' : 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(this.userFormData) }); if (!res.ok) throw new Error(await res.text()); alert(`User ${this.modalMode === 'add' ? 'created' : 'updated'} successfully!`); this.closeUserModal(); this.fetchData(); } catch (e) { alert(e.message); } },
            async deactivateUser(user) { if (!confirm(`Deactivate ${user.fullName}?`)) return; try { const res = await fetch(`/api/admin/users/${user._id}`, { method: 'DELETE' }); if (!res.ok) throw new Error('Failed.'); alert('User deactivated!'); this.fetchData(); } catch (e) { alert(e.message); } },
            openRequestDetailsModal(request) { this.selectedRequest = request; this.isRequestDetailsModalOpen = true; },
            closeRequestDetailsModal() { this.selectedRequest = null; this.isRequestDetailsModalOpen = false; },
            openBillModal(order) { this.billToView = order; this.isBillModalOpen = true; },
            closeBillModal() { this.billToView = null; this.isBillModalOpen = false; },
            openUserFoodHistoryModal(user) {
                this.selectedUserForHistory = user;
                this.selectedUserFoodOrders = this.allRequests.filter(r => r.requestType === 'food' && r.employeeId === user.employeeId);
                this.isUserFoodHistoryModalOpen = true;
            },
            closeUserFoodHistoryModal() { this.isUserFoodHistoryModalOpen = false; },
            openUserBillHistoryModal(bill) {
                this.selectedBillUser = bill;
                this.selectedBillUserOrders = this.allRequests.filter(r => r.requestType === 'food' && r.employeeId === bill.employeeId);
                this.isUserBillHistoryModalOpen = true;
            },
            closeUserBillHistoryModal() { this.isUserBillHistoryModalOpen = false; },
            async sendBroadcast() { if (!this.newBroadcastMessage.trim()) return; try { const res = await fetch('/api/admin/create-broadcast', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: this.newBroadcastMessage }) }); if (!res.ok) throw new Error('Failed.'); this.newBroadcastMessage = ''; alert('Broadcast sent!');} catch (e) { alert(e.message); } },
            
            // HELPERS & UTILITIES
            formatCurrency: (amount) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(amount || 0),
            formatDate(d, time = false) { if (!d) return 'N/A'; const opts = { day: 'numeric', month: 'short', year: 'numeric' }; if (time) { opts.hour = '2-digit'; opts.minute = '2-digit'; } return new Date(d).toLocaleDateString('en-IN', opts); },
            displayRating(r) { if (!r) return '<span class="text-xs italic text-slate-400">Not Rated</span>'; return '<span class="text-amber-500">' + ''.repeat(r) + ''.repeat(5 - r) + '</span>'; },
            getResolveNote(req) { return req.closingNote || req.dispatchNote || req.resolutionNote || 'N/A'; },

            downloadCSV(data, filename, headersMap) { if (!data || data.length === 0) return alert('No data to download.'); const headers = Object.keys(headersMap); const csvRows = [headers.join(',')]; data.forEach(row => { const values = headers.map(header => { const key = headersMap[header]; let val = row[key] ?? ''; if (typeof val === 'string') val = `"${val.replace(/"/g, '""')}"`; return val; }); csvRows.push(values.join(',')); }); const csvString = csvRows.join('\n'); const blob = new Blob([csvString], { type: 'text/csv' }); const url = window.URL.createObjectURL(blob); const a = document.createElement('a'); a.setAttribute('href', url); a.setAttribute('download', filename); a.click(); },
            downloadUsersCSV() { this.downloadCSV(this.filteredUsers, 'users.csv', { 'Full Name': 'fullName', 'Employee ID': 'employeeId', 'Email': 'email', 'Role': 'role', 'Department': 'department', 'Status': 'status', 'Phone': 'phone', 'Address': 'address' }); },
            downloadFullHistoryCSV() { this.downloadCSV(this.filteredFullHistory, 'full_history.csv', { 'Date': 'createdAt', 'User': 'requesterName', 'Service': 'type', 'Details': 'details', 'Status': 'status', 'Rating': 'rating', 'Resolve Note': 'closingNote' }); },
            downloadDepartmentHistoryCSV() { this.downloadCSV(this.filteredDepartmentHistory, `${this.departmentHistoryType}_history.csv`, { 'Date': 'createdAt', 'User': 'requesterName', 'Details': 'details', 'Status': 'status', 'Rating': 'rating', 'Resolve Note': 'closingNote' }); },
            downloadUserBillsCSV() { this.downloadCSV(this.userBills, 'user_bills.csv', { 'Full Name': 'fullName', 'Employee ID': 'employeeId', 'Department': 'department', 'Total Orders': 'totalOrders', 'Total Bill': 'totalBill' }); },

            formatRequestForDisplay(req, type) { let details = 'N/A', typeName = type; switch (type) { case 'ticket': typeName = 'IT Support'; details = req.mainIssue; break; case 'cleaning': typeName = 'Cleaning'; details = `${req.cleaningType} at ${req.floorNumber}`; break; case 'beverage': typeName = 'Beverage'; details = req.beverage; break; case 'food': typeName = 'Food'; details = req.items.map(i => `${i.name}(${i.quantity})`).join(', '); break; case 'store': typeName = 'Store Item'; details = `${req.itemName} (Qty: ${req.quantity})`; break; } return { ...req, requestType: type, type: typeName, details, uniqueId: `${type}-${req._id}` }; },
            getActivityIcon(activity, classes = 'w-5 h-5') { const typeInfo = this.formatRequestForDisplay(activity); let iconClass = ''; switch (typeInfo.requestType) { case 'ticket': iconClass = 'fa-solid fa-desktop text-indigo-500'; break; case 'cleaning': iconClass = 'fa-solid fa-pump-soap text-sky-500'; break; case 'beverage': case 'food': iconClass = 'fa-solid fa-utensils text-amber-500'; break; case 'store': iconClass = 'fa-solid fa-store text-purple-500'; break; default: return ''; } return `<i class="${iconClass} ${classes}"></i>`; },
            isActive(page) { return this.currentPage === page; }
        }
    }

    function liveClock() {
        return {
            time: '', date: '',
            start() { this.updateTime(); setInterval(() => { this.updateTime(); }, 1000); },
            updateTime() {
                const now = new Date();
                this.time = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true });
                this.date = now.toLocaleDateString('en-IN', { weekday: 'long', month: 'long', day: 'numeric' });
            }
        }
    }
    </script>
</body>
</html>